@page "/ActiveTime"
<h3>Active Time per User Management</h3>

@using Backend;
@using System.Linq;

<EditForm Model="activeTime">
    <select 
    @onchange="activeTime.OnValueChanged">
        @foreach (string user in activeTime.users)
        {
            <option>@user</option>
        }
    </select>
    <br />monday:   <input @bind='activeTime.dayOfTheWeekAndTime["monday"]' />
    <br />tuesday:  <input @bind='activeTime.dayOfTheWeekAndTime["tuesday" ]'  />
    <br />wednesday:<input @bind='activeTime.dayOfTheWeekAndTime["wednesday"] '  />
    <br />thursday: <input @bind='activeTime.dayOfTheWeekAndTime["thursday"]'  />
    <br />friday:   <input @bind='activeTime.dayOfTheWeekAndTime["friday"]'  />
    <br />saturday: <input @bind='activeTime.dayOfTheWeekAndTime["saturday"]'  />
    <br />sunday:   <input @bind='activeTime.dayOfTheWeekAndTime["sunday"]'  />

    <br /><label>
        Consumed time (hh:mi:ss): 
        <input @bind="activeTime.secondsTodayFormatted" />
    </label>

    <br /><button class="btn btn-primary" @onclick="activeTime.CommitValues">Commit Values</button>

</EditForm>

@code {
    ActiveTimeManagement activeTime = new ActiveTimeManagement();

    class ActiveTimeManagement
    {
        public Dictionary<string,int> dayOfTheWeekAndTime=new Dictionary<string, int>();
        private string currentUser;
        private ProcessSQL pSQL;
        private Monitor vMon;
        public string secondsTodayFormatted;
        public int secondsToday;
        //public int monday=0;
        //public int tuesday=0;
        //public int wednesday=0;
        //public int thursday=0;
        //public int friday=0;
        //public int saturday=0;
        //public int sunday=0;

        public List<string> users = new List<string>();
        public ActiveTimeManagement()
        {

            pSQL = new ProcessSQL();
            secondsToday = 0;
            users = Monitor.users;
            currentUser = users[0];

            dayOfTheWeekAndTime.Add("monday",0);
            dayOfTheWeekAndTime.Add("tuesday",0);
            dayOfTheWeekAndTime.Add("wednesday",0);
            dayOfTheWeekAndTime.Add("thursday",0);
            dayOfTheWeekAndTime.Add("friday",0);
            dayOfTheWeekAndTime.Add("saturday",0);
            dayOfTheWeekAndTime.Add("sunday",0);

            PopulateWeek();
            RefreshConsumedSeconds();
            //users.Add("alexa");
            //users.Add("Saray");
        }

        public void PopulateWeek()
        {
            foreach (AppsPersist app in pSQL.ListActiveTime().Where(m => m._userName == currentUser))
            {
                dayOfTheWeekAndTime[app._dayOfTheWeek.ToLower()] = app._time;
            }
        }
        public void RefreshConsumedSeconds()
        {
            secondsToday = pSQL.GetUserConsumedSeconds(currentUser);
            TimeSpan time = TimeSpan.FromSeconds(secondsToday);
            secondsTodayFormatted=time .ToString(@"hh\:mm\:ss");            
        }
        public Task OnValueChanged(ChangeEventArgs e)
        {
            currentUser = (string)e.Value;

            RefreshConsumedSeconds();
            //users=pSQL.GetUsers();
            PopulateWeek();

            return Task.CompletedTask;

        }
        public void CommitValues()
        {
            secondsToday=pSQL.GetUserConsumedSeconds(currentUser);
            foreach (string d in dayOfTheWeekAndTime.Keys)
            {
                pSQL.RemoveActiveTime(currentUser, d);
                pSQL.AddActiveTime(currentUser, dayOfTheWeekAndTime[d], d);
            }
            pSQL.SetUserConsumedSeconds(currentUser, secondsToday);
        }


    }



}